<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firewall: AI Safety Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Urbanist:wght@400;600;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
</head>

<body>

    <div class="game-container">

        <!-- HUD -->
        <div class="hud">
            <div class="stats-left">
                <div class="score-box">SCORE: <span id="score">0</span></div>
                <div class="timer-box"><i class="fa-regular fa-clock"></i> <span id="timer">00:00</span></div>
            </div>
            <div class="lives-box" id="lives">
                <i class="fa-solid fa-heart life"></i>
                <i class="fa-solid fa-heart life"></i>
                <i class="fa-solid fa-heart life"></i>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div class="card-stack" id="card-stack">
                <!-- Cards will be injected here -->
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-unsafe" id="btn-unsafe" onclick="handleChoice(false)">
                <i class="fa-solid fa-shield-halved"></i>
                Block / Unsafe
            </button>
            <button class="btn btn-safe" id="btn-safe" onclick="handleChoice(true)">
                <i class="fa-solid fa-paper-plane"></i>
                Safe to Send
            </button>
        </div>

        <!-- Feedback Overlay -->
        <div class="feedback-overlay" id="feedback-overlay">
            <div class="feedback-icon" id="fb-icon"></div>
            <h2 class="feedback-title" id="fb-title"></h2>
            <p class="feedback-desc" id="fb-desc"></p>
            <button class="btn-continue" onclick="nextCard()">Continue</button>
        </div>

        <!-- Start Screen -->
        <div class="screen" id="start-screen">
            <i class="fa-solid fa-robot"
                style="font-size: 5rem; background: linear-gradient(to left, var(--accent-arc-red), var(--accent-arc-white)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px;"></i>
            <h1>FIREWALL</h1>
            <p>You are the AI Safety Officer.<br>Allow safe prompts. Block the dangerous ones.</p>
            <button class="btn-start" onclick="startGame()">START MISSION</button>
            <button class="btn-secondary" onclick="showLeaderboard()">LEADERBOARD</button>
        </div>

        <!-- Game Over Screen -->
        <div class="screen hidden" id="end-screen">
            <i class="fa-solid fa-trophy" style="font-size: 4rem; color: #fbbf24; margin-bottom: 10px;"></i>
            <h1>MISSION COMPLETE</h1>
            <p>Score: <span id="final-score" style="color:white; font-weight:bold;">0</span> | Time: <span
                    id="final-time" style="color: #10b981; font-weight:bold;">0s</span></p>

            <input type="text" id="player-name" class="player-name-input" placeholder="ENTER YOUR NAME" maxlength="15">

            <button class="btn-start" onclick="submitScore()">SUBMIT SCORE</button>
            <button class="btn-secondary" onclick="startGame()">PLAY AGAIN</button>
        </div>

        <!-- Leaderboard Screen -->
        <div class="screen hidden" id="leaderboard-screen">
            <h1 style="font-size: 2.5rem;">TOP AGENTS</h1>
            <div class="leaderboard-list" id="leaderboard-list">
                <!-- Scores injected here -->
                <div class="leaderboard-item"><span>Loading...</span></div>
            </div>
            <button class="btn-secondary" onclick="returnToStart()">BACK TO MENU</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // CONFIGURATION SECTION
        // ==========================================

        // 1. Go to console.firebase.google.com and create a new project.
        // 2. Create a Web App and copy the config object below.
        // 3. Create a Firestore Database (Start in Test Mode).
        // 4. Create a collection named 'scores'.

        const firebaseConfig = {
            apiKey: "AIzaSyAyU00HzXRIx7DRP7GpFP-Nf196CeQArlA",
            authDomain: "planning-with-ai-7214a.firebaseapp.com",
            projectId: "planning-with-ai-7214a",
            storageBucket: "planning-with-ai-7214a.firebasestorage.app",
            messagingSenderId: "657589690656",
            appId: "1:657589690656:web:96322296770501094b7745"
        };

        // ==========================================
        // END CONFIGURATION
        // ==========================================

        let db = null;
        let isOnline = false;

        // Initialize Firebase if config is present
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isOnline = true;
                console.log("Connected to Firebase Cloud Leaderboard");
            } catch (e) {
                console.error("Firebase init failed:", e);
            }
        } else {
            console.log("No Firebase config found. Using LocalStorage mode.");
        }

        // Make functions available globally
        window.saveScoreToBackend = async (name, score, duration) => {
            if (isOnline && db) {
                try {
                    await addDoc(collection(db, "scores"), {
                        name: name,
                        score: score,
                        duration: duration,
                        timestamp: Date.now()
                    });
                } catch (e) {
                    console.error("Error saving score:", e);
                    alert("Could not save score online.");
                }
            } else {
                // Local Fallback
                const localScores = JSON.parse(localStorage.getItem('firewall_scores') || '[]');
                localScores.push({ name, score, duration, timestamp: Date.now() });
                localStorage.setItem('firewall_scores', JSON.stringify(localScores));
            }
        };

        window.fetchTopScores = async () => {
            let scores = [];
            if (isOnline && db) {
                try {
                    // Fetch top 50 by score, then we sort by time in JS
                    const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(50));
                    const querySnapshot = await getDocs(q);
                    scores = querySnapshot.docs.map(doc => doc.data());
                } catch (e) {
                    console.error("Error fetching scores:", e);
                }
            } else {
                // Local Fallback
                scores = JSON.parse(localStorage.getItem('firewall_scores') || '[]');
            }

            // Client-side Sort: Primary = Score (Desc), Secondary = Duration (Asc)
            scores.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                // If scores are equal, lower duration wins.
                // Handle cases where duration might be missing (treat as infinite/slow)
                const durA = a.duration || 999999;
                const durB = b.duration || 999999;
                return durA - durB;
            });

            return scores.slice(0, 10);
        };

    </script>

    <script>
        let scenarios = [];
        async function loadDatabase() {
            const response = await fetch('./data.json');
            scenarios = await response.json();


            console.log('Db loaded:', scenarios.length, 'scenarios'); // Your data is now a usable JS array
        }

        loadDatabase();
        // Game Data - Pool of 30 questions

        // State
        let currentCardIndex = 0;
        let score = 0;
        let lives = 3;
        let shuffledScenarios = [];
        let startTime = 0;
        let timerInterval = null;
        let finalDuration = 0;

        // DOM Elements
        const cardStack = document.getElementById('card-stack');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const livesDisplay = document.getElementById('lives');
        const startScreen = document.getElementById('start-screen');
        const endScreen = document.getElementById('end-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalTimeDisplay = document.getElementById('final-time');
        const playerNameInput = document.getElementById('player-name');

        function startGame() {
            score = 0;
            lives = 3;
            currentCardIndex = 0;
            finalDuration = 0;
            updateHUD();

            // RANDOMIZATION LOGIC:
            shuffledScenarios = [...scenarios]
                .sort(() => Math.random() - 0.5)
                .slice(0, 10);

            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            leaderboardScreen.classList.add('hidden');

            startTimer();
            renderCard();
        }

        function startTimer() {
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                timerDisplay.textContent = formatTime(elapsed);
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                finalDuration = Date.now() - startTime;
                timerDisplay.textContent = formatTime(finalDuration);
            }
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateHUD() {
            scoreDisplay.textContent = score;
            const hearts = livesDisplay.children;
            for (let i = 0; i < 3; i++) {
                if (i < lives) {
                    hearts[i].classList.remove('lost');
                } else {
                    hearts[i].classList.add('lost');
                }
            }
        }

        function renderCard() {
            if (currentCardIndex >= shuffledScenarios.length) {
                endGame();
                return;
            }

            const data = shuffledScenarios[currentCardIndex];
            cardStack.innerHTML = ''; // Clear previous

            const card = document.createElement('div');
            card.className = 'prompt-card';
            card.innerHTML = `
                <div class="prompt-icon">
                    <i class="fa-solid ${data.type === 'safe' ? 'fa-message' : 'fa-triangle-exclamation'}"></i>
                </div>
                <h3>INCOMING PROMPT (${currentCardIndex + 1}/10)</h3>
                <div class="prompt-content">"${data.text}"</div>
            `;

            // Add animation class
            card.style.animation = 'slideIn 0.5s ease-out';
            cardStack.appendChild(card);
        }

        function handleChoice(userSaysSafe) {
            const currentScenario = shuffledScenarios[currentCardIndex];
            const isCorrect = userSaysSafe === currentScenario.isSafe;

            if (isCorrect) {
                // Win
                score += 100;
                showFeedback(true, "Correct!", currentScenario.reason);
            } else {
                // Lose
                lives--;
                document.querySelector('.game-container').classList.add('shake');
                setTimeout(() => document.querySelector('.game-container').classList.remove('shake'), 500);
                showFeedback(false, "Security Breach!", currentScenario.reason);
            }
            updateHUD();
        }

        function showFeedback(success, title, desc) {
            const icon = document.getElementById('fb-icon');
            const titleEl = document.getElementById('fb-title');
            const descEl = document.getElementById('fb-desc');
            const overlay = document.getElementById('feedback-overlay');

            if (success) {
                icon.innerHTML = '<i class="fa-solid fa-check-circle"></i>';
                icon.style.color = '#10b981';
                titleEl.style.color = '#10b981';
            } else {
                icon.innerHTML = '<i class="fa-solid fa-circle-xmark"></i>';
                icon.style.color = '#ef4444';
                titleEl.style.color = '#ef4444';
            }

            titleEl.textContent = title;
            descEl.textContent = desc;
            overlay.classList.add('active');

            // Disable buttons behind
            document.getElementById('btn-safe').disabled = true;
            document.getElementById('btn-unsafe').disabled = true;
        }

        function nextCard() {
            document.getElementById('feedback-overlay').classList.remove('active');
            document.getElementById('btn-safe').disabled = false;
            document.getElementById('btn-unsafe').disabled = false;

            currentCardIndex++;

            if (lives <= 0) {
                endGame();
            } else {
                renderCard();
            }
        }

        function endGame() {
            stopTimer();
            endScreen.classList.remove('hidden');
            finalScoreDisplay.textContent = score;
            finalTimeDisplay.textContent = formatTime(finalDuration);
            playerNameInput.value = ""; // Reset input
            playerNameInput.focus();
        }

        async function submitScore() {
            const name = playerNameInput.value.trim() || "Anonymous";

            // Call the module function we attached to window
            if (window.saveScoreToBackend) {
                await window.saveScoreToBackend(name, score, finalDuration);
            }

            showLeaderboard();
        }

        async function showLeaderboard() {
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            leaderboardScreen.classList.remove('hidden');

            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = '<div class="leaderboard-item"><span>Loading scores...</span></div>';

            let scores = [];
            if (window.fetchTopScores) {
                scores = await window.fetchTopScores();
            }

            listEl.innerHTML = '';
            if (scores.length === 0) {
                listEl.innerHTML = '<div class="leaderboard-item" style="justify-content:center; color:#94a3b8;">No records yet. Be the first!</div>';
                return;
            }

            scores.forEach((s, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';

                // Medal Logic
                let rankDisplay = `#${index + 1}`;
                if (index === 0) {
                    rankDisplay = '<i class="fa-solid fa-medal" style="color: #ffd700;"></i>';
                    item.classList.add('gold');
                } else if (index === 1) {
                    rankDisplay = '<i class="fa-solid fa-medal" style="color: #c0c0c0;"></i>';
                    item.classList.add('silver');
                } else if (index === 2) {
                    rankDisplay = '<i class="fa-solid fa-medal" style="color: #cd7f32;"></i>';
                    item.classList.add('bronze');
                }

                const durationSec = s.duration ? (s.duration / 1000).toFixed(1) + 's' : '-';

                item.innerHTML = `
            <div class="rank-name"><span class="medal-slot">${rankDisplay}</span> ${s.name}</div>
            <div class="score-val">${s.score}</div>
            <div class="time-val">${durationSec}</div>`;
                listEl.appendChild(item);
            });
        }

        function returnToStart() {
            leaderboardScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        }

        // Add basic key controls
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('feedback-overlay').classList.contains('active')) {
                if (e.key === 'Enter' || e.key === ' ') nextCard();
                return;
            }
            // Game over screen input handling
            if (!endScreen.classList.contains('hidden')) {
                if (e.key === 'Enter') submitScore();
                return;
            }
            if (startScreen.classList.contains('hidden') && endScreen.classList.contains('hidden') && leaderboardScreen.classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') handleChoice(false);
                if (e.key === 'ArrowRight') handleChoice(true);
            }
        });

    </script>
</body>

</html>